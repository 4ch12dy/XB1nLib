//
// Created by xia0 on 2019/11/7.
//

#include "arm.h"

uint32_t arm_insn_from_addr(void* addr){
    uint32_t insn = *((uint32_t*)addr);
    return insn;
}
Arm_Addr arm_addr_add(Arm_Addr addr, int32_t insn_count){
    return addr + 4*insn_count;
}


// arm ldr
/*   ldr(literal)
 *   ldr    <Rt>    [PC, #imm]
 *
 *  | 31    28| 27 26 25  24   23   22   21   20 |19     16| 15    12| 11                   0|
 *  +---------+---------+----+----+----+----+----+---------+---------+-----------------------+
 *  |   cond  | 0  1  0 | P  | U  | 0  | W  | 1  | 1 1 1 1 |    Rt   |          imm12        |
 *  +---------+---------+----+----+----+----+----+---------+---------+-----------------------+
*/
int arm_is_ldr_literal(uint32_t insn){
    return (insn & 0x0E1F0000) == 0x041F0000;
}

int32_t arm_ldr_literal_decode_imm(uint32_t insn){
    assert(arm_is_ldr_literal(insn));
    const  int mask12 = (1 << 12) - 1;
    int32_t imm = insn & mask12;
    return imm;
}
/*   ldr(register, ARM)
 *   ldr    <Rt>    [<Rn>, +/-<Rm>]{, <shift>}
 *
 *  | 31    28| 27 26 25  24   23   22   21   20 |19     16| 15    12| 11      7| 6 5 | 4   3      0|
 *  +---------+---------+----+----+----+----+----+---------+---------+----------------+----+--------+
 *  |   cond  | 0  1  1 | P  | U  | 0  | W  | 1  |    Rn   |    Rt   |    imm5  |type |  0 |   Rm   |
 *  +---------+---------+----+----+----+----+----+---------+---------+---------------------+--------+
*/
int arm_is_ldr_r(Arm_Insn insn){
    return (insn & 0x0E500010) == 0x06100000;
}

// arm mov
/*   mov(immediate)
 *   mov    <Rt>    #<const>
 *
 *  | 31    28| 27 26  25  24     21  20  19          16| 15    12| 11                   0|
 *  +---------+------+----+---------+----+--------------+---------+-----------------------+
 *  |   cond  | 0  0 | 1  | 1 1 0 1 | S  | (0)(0)(0)(0) |    Rd   |        imm12          |
 *  +---------+------+----+---------+----+--------------+---------+-----------------------+
*/
int arm_is_mov_imm(uint32_t insn){
    return (insn & 0x0FEF0000) == 0x03A00000;
}

// arm add
/*   add(register-shifted register)
 *   add    <Rd>, <Rn>, <Rm>, <type>    <Rs>
 *
 *  | 31    28| 27 26  25  24     21  20  19     16| 15    12| 11     8  7    6  5  4   3      0|
 *  +---------+------+----+---------+----+---------+---------+---------+----+-----+----+--------+
 *  |   cond  | 0  0 | 0  | 0 1 0 0 | S  |    Rn   |    Rd   |    Rs   | 0  |type | 1  |   Rm   |
 *  +---------+------+----+---------+----+---------+---------+---------+----+-----+----+--------+
*/
int arm_is_add_rsr(uint32_t insn){
    return (insn & 0x0FE00090) == 0x00800010;
}

/*   add(register, ARM)
 *   add    <Rd>, <Rn>, <Rm>{, <shift>}
 *
 *  | 31    28| 27 26  25  24     21  20  19     16| 15    12| 11          7  6  5  4   3      0|
 *  +---------+------+----+---------+----+---------+---------+--------------+-----+----+--------+
 *  |   cond  | 0  0 | 0  | 0 1 0 0 | S  |    Rn   |    Rd   |     imm5     |type | 0  |   Rm   |
 *  +---------+------+----+---------+----+---------+---------+--------------+-----+----+--------+
*/
int arm_is_add_r(uint32_t insn){
    return (insn & 0x0FE00010) == 0x00800000;
}

